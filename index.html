<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <link rel="stylesheet" href="style.css">
  <title>Document</title>
</head>

<body>

  <h2>hola</h2>
  <!-- <input type="file" accept="video/*" /> -->

  <video id="v" controls>
    <source src="video.mov" type="video/mp4">
  </video>
  <p id="progress"></p>

  <script>
    // document.querySelector('input').addEventListener('change', extractFrames, false);
    document.querySelector('video').addEventListener('loadeddata', extractFrames, false);

    function extractFrames() {
      var video = document.querySelector('#v');
      var array = [];
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d');
      var pro = document.querySelector('#progress');

      function initCanvas(e) {
        canvas.width = this.videoWidth;
        canvas.height = this.videoHeight;
        console.log('canvas init', cavas);

      }

      function drawFrame(e) {
        ctx.drawImage(this, 0, 0, canvas.width, canvas.height);
        //merge
        firstData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        currentData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        merge(firstData,currentData);

        //TODO
        canvas.toBlob(saveFrame, 'image/png');
        pro.innerHTML = ((this.currentTime / this.duration) * 100).toFixed(2) + ' %';
        
        if (this.currentTime < this.duration) {
          this.pause();
          nextFrame(this.currentTime);
          this.play();
        }
      }

      function merge(firstData,currentData) {

        var limit = firstData.data.length;
        for (var i = 0; i < limit; i++) {
          if (firstData.data[i] !== currentData.data[i]) {
            firstData.data[i] = currentData[i];
            console.log('change ', firstData.data[i], '    ', i);
          }          
          return firstData.data;
        }
      }

      function nextFrame(currentTime) {
        console.log('crt ', currentTime);
        return (currentTime += 1 / 2);

      }

      function saveFrame(blob) {
        array.push(blob);
      }

      function revokeURL(e) {
        URL.revokeObjectURL(this.src);

      }

      function onend(e) {
        var img;
        // do whatever with the frames
        console.log('ar_', array.length);

        for (var i = 0; i < array.length; i++) {
          console.log('i     ', i);
          img = new Image();
          img.onload = revokeURL;
          img.src = URL.createObjectURL(array[i]);
          document.body.appendChild(img);
        }
        // we don't need the video's objectURL anymore
        URL.revokeObjectURL(this.src);

      }

      var firstData;
      video.muted = true;

      video.addEventListener('onloadeddata', initCanvas, false);
      video.addEventListener('timeupdate', drawFrame, false);
      // video.addEventListener('seeked', drawFrame, false);
      video.addEventListener('ended', onend, false);

      // video.src = URL.createObjectURL(this.files[0]);
      // video.play();
    }
  </script>

</body>

</html>